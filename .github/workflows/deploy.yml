name: ğŸš€ Deploy Crypto Tracker

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_REGISTRY: docker.io
  BACKEND_IMAGE: iddris/crypto-tracker-backend
  FRONTEND_IMAGE: iddris/crypto-tracker-frontend

jobs:
  # Test Stage
  test:
    name: ğŸ§ª Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: crypto-tracker-frontend/package-lock.json

    - name: ğŸ—ï¸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Install Frontend Dependencies
      working-directory: ./crypto-tracker-frontend
      run: npm ci --legacy-peer-deps

    - name: ğŸ“¦ Install Backend Dependencies
      working-directory: ./crypto-tracker-backend
      run: |
        python -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt

    - name: ğŸ” Lint Frontend
      working-directory: ./crypto-tracker-frontend
      run: |
        npx eslint . --ext .js,.jsx,.ts,.tsx --max-warnings 0 || true
        echo "âœ… Frontend linting completed"

    - name: ğŸ”§ Build Frontend
      working-directory: ./crypto-tracker-frontend
      run: npm run build
      env:
        VITE_API_URL: https://crypto-tracker-backend.onrender.com

    - name: âœ… Test Backend Health
      working-directory: ./crypto-tracker-backend
      run: |
        source venv/bin/activate
        python -c "import app; print('âœ… Backend imports successfully')"

  # Build and Push Docker Images
  build:
    name: ğŸ³ Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: ğŸ³ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./crypto-tracker-${{ matrix.service }}
        file: ./crypto-tracker-${{ matrix.service }}/Dockerfile
        push: true
        tags: |
          ${{ matrix.service == 'backend' && env.BACKEND_IMAGE || env.FRONTEND_IMAGE }}:latest
          ${{ matrix.service == 'backend' && env.BACKEND_IMAGE || env.FRONTEND_IMAGE }}:v1
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          ${{ matrix.service == 'frontend' && 'VITE_API_URL=https://crypto-tracker-backend-8x7x.onrender.com' || '' }}

  # Deploy to Render
  deploy:
    name: ğŸš€ Deploy to Render
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4

    - name: ğŸš€ Trigger Render Deploy - Backend
      run: |
        curl -X POST "${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}" \
          -H "Content-Type: application/json" \
          -d '{
            "branch": "main",
            "commit": "${{ github.sha }}"
          }'
        echo "âœ… Backend deployment triggered"

    - name: ğŸš€ Trigger Render Deploy - Frontend
      run: |
        # Wait for backend to deploy first
        sleep 30
        curl -X POST "${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}" \
          -H "Content-Type: application/json" \
          -d '{
            "branch": "main", 
            "commit": "${{ github.sha }}"
          }'
        echo "âœ… Frontend deployment triggered"

    - name: ğŸ“‹ Deployment Summary
      run: |
        echo "ğŸ‰ Deployment Complete!"
        echo "ğŸ”— Frontend URL: ${{ secrets.RENDER_FRONTEND_URL }}"
        echo "ğŸ”— Backend URL: ${{ secrets.RENDER_BACKEND_URL }}"
        echo "ğŸ“Š Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"

  # Health Check
  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ¥ Check Backend Health
      run: |
        echo "Waiting for backend to be ready..."
        sleep 60
        
        for i in {1..5}; do
          if curl -f "${{ secrets.RENDER_BACKEND_URL }}/health"; then
            echo "âœ… Backend is healthy!"
            break
          else
            echo "â³ Attempt $i/5 failed, retrying in 30s..."
            sleep 30
          fi
        done

    - name: ğŸ¥ Check Frontend Health  
      run: |
        echo "Checking frontend availability..."
        sleep 30
        
        for i in {1..3}; do
          if curl -f "${{ secrets.RENDER_FRONTEND_URL }}"; then
            echo "âœ… Frontend is healthy!"
            break
          else
            echo "â³ Attempt $i/3 failed, retrying in 30s..."
            sleep 30
          fi
        done

    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ ğŸ‰ ğŸ‰ DEPLOYMENT SUCCESSFUL! ğŸ‰ ğŸ‰ ğŸ‰"
        echo ""
        echo "ğŸŒ Your Crypto Tracker is now live at:"
        echo "   Frontend: ${{ secrets.RENDER_FRONTEND_URL }}"
        echo "   Backend:  ${{ secrets.RENDER_BACKEND_URL }}"
        echo ""
        echo "ğŸ“ˆ Happy crypto tracking! ğŸš€"